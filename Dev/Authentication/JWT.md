# JWT (JSON Web Token)

<br>

## 1. JWT 란? 

> - JWT란 Json Web Token의 약자이자, <u><b>개체간 JSON을 사용하여 정보를 안전하게 전송</b>하기 위한 독립적이고 컴팩트한 웹표준 (RFC 7519)이다.</u>
> - <b>인증에 필요한 정보들을 암호화시킨 토큰</b>

<br>

## 2. JWT 특징 

> 1. Self-contained (자가수용적) <br>
> : JWT는 필요한 모든 정보를 자체적으로 지니고 있다. JWT 시스템에서 발급된 토큰은 토큰에 대한 기본정보, 전달 할 정보, 토큰이 검증됐다는 것을 증명해주는 signature를 포함하고 있다.
> 2. 신뢰성 <br>
> : JWT는 디지털 서명에 의해 검증할 수 있으며 신뢰할 수 있다. 비밀 값을 사용하는 HMAC 알고리즘이나 RDS와 같은 공개키, 개인키 쌍으로 서명 될 수 있다. 
> 3. 쉬운 전달성 <br>
> : JWT는 자가수용적이므로 두 개체 사이에서 손쉽게 전달 될 수 있다. 웹서버의 경우 HTTP의 헤더에 넣어서 전달하거나 URL의 파라미터로 전달 할 수 있다. 

<br>

## 3. JWT를 왜 사용할까? 

> 1. CORS <br>
> : JWT는 쿠키를 사용하지 않기 때문에, CORS (Cross-Origin Resource Sharing) 이슈가 발생하지 않는다. 
> ```
> 쿠키는 발행한 서버에서만 유효한다. 
> test1 서버에서 발행한 쿠키는 test2 서버에서는 사용할 수 없다는 이슈가 있다. 
> ```
> 2. 데이터 용량 <br>
> : JWT는 기존의 XML보다 덜 복잡하고 인코딩 된 사이즈가 작다. 
> 3. 토큰 기반으로 하는 다른 인증 시스템에 접근 가능 <br>
> : Facebook 로그인, Google 로그인 등 

<br>

## 4. JWT는 어떠한 상황에서 사용되는가? 

> 1. 회원인증 <br> 
> : 유저가 로그인을 하면, 서버는 유저의 정보에 기반한 토큰을 발급하여 유저에게 전달해준다. 그 후, 유저가 서버에 요청을 할 때마다 헤더에 JWT를 포함하여 전달한다. <br>
> 서버가 클라이언트에게서 요청을 받을때 마다 해당 토큰이 유효한지 확인하고 인증 여부를 검증하고, 유저가 요청한 작업에 권한이 있는지 확인하여 작업을 처리한다. <br>
> <u>서버측에서는 유저의 세션을 유지 할 필요가 없다.</u> 때문에 서버 자원을 많이 아낄 수 있다. 
> 2. 정보교류 <br>
> : 정보가 sign이 되어있기 때문에 정보가 도중이 조작되지는 않았는지 검증 할 수 있다.

<br>

## 5. JWT 구조 

JWT는 `.`을 구분자로 Header, Payload, Signature라는 3가지의 문자열로 되어있다. 
![](../../img/jwt.png)
> JWT토큰을 만들때는 JWT를 담당하는 라이브러리가 자동으로 인코딩 및 해싱 작업을 해준다.

### Header 
Header는 token의 type과 서명에 사용될 alg(알고리즘)을 지니고 있다. 
> typ: 토큰의 타입을 지정 (<u>**JWT**</u>) <br>
> alg: 해싱 알고리즘을 지정한다. 해싱 알고리즘은 보통 HMAC SHA256 또는 RSA가 사용되며, 이 알고리즘은 <u>토큰을 검증할 때 사용되는 signature 부분에서 사용됨</u> 
```json
{
    "typ": "JWT",
    "alg": "HS256"
}
```

### payload
Payload는 토큰에 담을 정보가 들어있다. 여기에 담는 정보의 한 조각을 **클레임(claim)**이라 부르고, 이는 name/value의 한쌍으로 이뤄져있으며 클레임은 객체나 추가적인 데이터를 표현한다. <br>
클레임은 아래와 같이 3가지의 유형으로 나뉘게 된다. 

#### 1. 등록된 클레임 (Registered claim)
> 서비스에서 필요한 정보들이 아닌, 토큰에 대한 정보들을 담기위하여 이름이 이미 정해진 클레임이다. 등록된 클레임의 사용은 모두 선택적 (optional)이다. 

#### 2. 공개 클레임 (public claim) 
> JWT를 사용하는 사람들에 의해 정의되는 클레임이다. 공개 클레임들은 충돌이 방지된 (collision-resistant) 이름을 가지고 있어야 한다. 충돌을 방지하기 위해서는 클레임 이름을 URI형식으로 짓는다. 
```json
{
    "https://test.com/jwt_claims/is_admin": true
}
```

#### 3. 비공개 클레임 (private claim) 
> 정보를 공유하는 개체간(클라이언트-서버)의 협의하에 사용되는 클레임 이름이다. 공개 클레임과는 달리 이름이 중복되어 충돌이 될 수 있으니 사용할 때 유의해야 함 
```json
{
    "username": "woochan"
}
```

#### 예제 Payload 
```json 
{
    "iss": "test.com", // 토큰 발급자 (issuer) 
    "https://test.com/jwt_claims/is_admin": true,
    "username": "woochan"
}
```

### signature
Signature는 인코딩된 Header와 Payload를 합쳐 Header의 서명 알고리즘 정보(alg)를 가져와 암호화하여 생성한다. <br>
서명은 메세지가 변경됬는지 검증하기 위해 사용하며 개인키로 암호화된 토큰은 발신자가 누구인지 확인 할 수 있다. 

> 최종적으로 `.`으로 구분되는 Base64 인코딩 문자열이 3개가 나오게 되고, 실제 JWT의 예를 보면 아래와 같다. 
> ![](../../img/jwt2.png)
> <br>
> Header와 Payload는 인코딩될 뿐 따로 암호화되지 않는다. 따라서 JWT 토큰에서 Header, Payload는 누구나 디코딩하여 확인할 수 있다. 여기서 누구나 디코딩 할 수 있다는 말은 <u>Payload에는 유저의 중요한 정보가 들어가면 쉽게 노출될 수 있다</u>는 말이다. <br>
> 하지만 Signature는 SECRET KEY를 알지 못하면 복호화 할 수 없다.

<br>

## 6. JWT 동작원리 

![](../../img/jwt3.png)

(JWT가 없는 상황을 가정)

> 1. 사용자가 회원가입 후, 로그인 요청 
> 2. 서버에서는 회원 DB로부터 계정정보를 읽어 사용자를 확인한 후, 사용자 고유 ID를 부여 한 후, 기타 정보와 함께 Payload에 넣는다. 
> 3. 암호화할 SECRET KEY를 이용해 Access Token을 발급한다. 
> 4. 로그인이 성공적으로 진행되었으면 Client는 Server로 부터 Access Token을 받음. 
> 5. 이후 Client는 인증이 필요한 요청마다 Access Token을 헤더에 넣어서 요청한다.
> 6. 서버는 해당 토큰의 Signature를 SECRET KEY로 복호화 한 후, 조작여부, 유효기간을 확인함. 
> 7. 검증이 완료되면 Payload를 디코딩하여 사용자 요청에 따른 데이터를 응답해줌.  

<br>

## 7. JWT 장·단점 

### 장점 
> - 세션/쿠키는 별도의 저장소가 필요한 반면 JWT는 발급한 후 검증만 하면 되기 때문에 추가 저장소가 필요 없다. <br>
> 때문에 서버를 확장하거나 유지, 보수하는데 유리하다. 
> - 토큰 기반으로 하는 다른 인증 시스템에 접근이 가능하다. <br>
>   - Facebook 로그인, Google Login 등 

### 단점 
> - 세션/쿠키의 경우 세션ID가 변질되었다고 판단되면 해당 세션/쿠키를 지우면 되지만 JWT는 한번 발급되면 유효기간이 완료될 때까지 계속 사용이 가능하므로 이 기간동안에 정보들을 탈취당할 수도 있다. 
>   - 기존의 Access Token의 유효기간을 짧게 하고 Refresh Token이라는 새로운 토큰을 발급합니다. 그렇게 되면 Access Token을 탈취당해도 상대적으로 피해를 줄일 수 있다.
> - 클라이언트가 계속 시스템을 이용하다가 access 토큰 기한이 만료된다면 사용중에 갑자기 로그인을 하라고 할 것이다.
> - 만료기간이 짧다면 로그인 주기가 짧아질 것이며, 만료기간이 길다면 해커로부터 정보를 탈취 당할 위험이 있다. 

<br><br>

## 참고사이트 
1. https://tansfil.tistory.com/58
2. https://velopert.com/2389
3. https://medium.com/sjk5766/jwt-json-web-token-%EC%86%8C%EA%B0%9C-49e211c65b45